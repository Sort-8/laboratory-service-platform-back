<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.miku.lab.dao.BookLogDao">


    <select id="getAllBookLog" resultType="com.miku.lab.entity.BookLog" parameterType="com.miku.lab.entity.BookLog">
        select *from sys_booking_log
        <where>
            del_flag=0
        </where>
    </select>

    <select id="getAllBookMachineById" resultType="com.miku.lab.entity.BookMachine" parameterType="com.miku.lab.entity.BookMachine">
        select *from wx_booking_machine
        <where>
            openId=#{openId} and del_flag=0 and valid_status=1
        </where>
    </select>

    <select id="getWxUserByOpenId" resultType="com.miku.lab.entity.WxUser" parameterType="com.miku.lab.entity.BookMachine">
        select *from wx_booking_user
        <where>
            openId=#{openId} and del_flag=0
        </where>
    </select>

    <select id="getMachineAndCount" resultType="com.miku.lab.entity.Machine" parameterType="map">
        select *from sys_machine
        <where>
            machine_id=#{machine_id} and bookable_count>=#{book_number} and del_flag=0
        </where>
    </select>

    <select id="getMachine" resultType="com.miku.lab.entity.Machine" parameterType="map">
        select *from sys_machine
        <where>
            machine_id=#{machine_id}  and del_flag=0
        </where>
    </select>

    <insert id="addBookMachine" parameterType="map">
        insert
        into wx_booking_machine(openId,booking_code,machine_code,machine_number,del_flag,create_time)
        values(#{openId},#{booking_code},#{machine_id},#{book_number},0,NOW())
    </insert>

    <update id="updateMachine" parameterType="map">
        update sys_machine
        set bookable_count=#{last_number}
        <where>
            machine_id=#{machine_id}
        </where>
    </update>

    <select id="getLabById" resultType="com.miku.lab.entity.LabInfo" parameterType="com.miku.lab.entity.OrderCheck">
        select *from sys_lab_info
        <where>
            lab_id=#{labId} and del_flag=0
        </where>
    </select>

    <update id="updateLabSetStatus" parameterType="com.miku.lab.entity.OrderCheck">
        update sys_lab_info
        set lab_status=1,update_time=NOW()
        <where>
            lab_id=#{labId}
        </where>
    </update>


    <insert id="addBookLab" parameterType="com.miku.lab.entity.OrderCheck">
        insert
        into sys_order_check(openId,booking_code,username,lab_id,
             order_applyer,order_phone,order_number,lab_name,remark,
             start_time,end_time,checker,check_status,create_time,del_flag)
        values(
                #{openId},#{bookingCode},#{username},#{labId},
                #{orderApplyer},#{orderPhone},#{orderNumber},#{labName},#{remark},
                #{startTime},#{endTime},#{checker},0,NOW(),0
                )
    </insert>

    <update id="updateNumberByOpenIdAndMachineId" parameterType="map">
        update wx_booking_machine
        set machine_number=#{machine_number},update_time=NOW()
        <where>
            openId=#{openId} and machine_code=#{machine_id} and del_flag=0
        </where>
    </update>

    <select id="getBookLogByOpenIdAndMachineId" resultType="com.miku.lab.entity.BookMachine" parameterType="map">
        select *from wx_booking_machine
        <where>
            openId=#{openId} and machine_code=#{machine_id} and del_flag=0
        </where>
    </select>

    <update id="delWxBookMachine" parameterType="map">
        update wx_booking_machine
        set del_flag=1,del_time=NOW()
        <where>
            openId=#{openId} and machine_code=#{machine_id} and del_flag=0
        </where>
    </update>


    <insert id="addBookingLog" parameterType="map">
        insert
        into sys_booking_log(booking_code,creater,create_time,del_flag)
        values(
                #{booking_code},#{creater},NOW(),0
                )
    </insert>




</mapper>
